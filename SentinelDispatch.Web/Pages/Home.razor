@page "/"
@using SentinelDispatch.Web.Models
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

<PageTitle>Sentinel Dispatch</PageTitle>

<div class="dashboard-container">
    <div class="sidebar">
        <h3>Active Incidents</h3>
        <ul class="incident-list">
            @foreach (var incident in Incidents)
            {
                <li class="incident-item" @onclick="() => FocusIncident(incident)">
                    <strong>@incident.Description</strong><br/>
                    <small>@incident.Location</small><br/>
                    <span class="badge @GetStatusClass(incident.Status)">@incident.Status</span>
                </li>
            }
        </ul>
    </div>
    <div class="map-container">
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>
</div>

<style>
    .dashboard-container {
        display: flex;
        height: 90vh;
        width: 100%;
    }
    .sidebar {
        width: 300px;
        background: #f4f4f4;
        padding: 10px;
        overflow-y: auto;
        border-right: 1px solid #ddd;
    }
    .map-container {
        flex-grow: 1;
    }
    .incident-list {
        list-style: none;
        padding: 0;
    }
    .incident-item {
        background: white;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .incident-item:hover {
        background: #e9ecef;
    }
    .badge {
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8em;
        color: white;
    }
    .bg-created { background: #007bff; }
    .bg-dispatched { background: #ffc107; color: black; }
    .bg-onscene { background: #28a745; }
    .bg-closed { background: #6c757d; }
</style>

@code {
    private List<Incident> Incidents = new();
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await LoadIncidents();

        var baseUrl = Configuration["services:incidentservice:http:0"]; 
        // Need to append /hub to the base URL or provided URL
        var hubUrl = $"{baseUrl}/hub";

        hubConnection = new HubConnectionBuilder()
            .WithUrl(hubUrl)
            .Build();

        hubConnection.On<Incident>("IncidentReceived", (incident) =>
        {
            Incidents.Insert(0, incident);
            AddMarker(incident);
            StateHasChanged();
        });

        await hubConnection.StartAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initMap", "map");
            foreach (var inc in Incidents)
            {
                AddMarker(inc); // Add existing markers
            }
        }
    }

    private async Task LoadIncidents()
    {
        var client = HttpClientFactory.CreateClient("IncidentAPI");
        try 
        {
            Incidents = await client.GetFromJsonAsync<List<Incident>>("/incidents") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading incidents: {ex.Message}");
        }
    }

    private void FocusIncident(Incident incident)
    {
        // Zoom to incident logic (future)
        Console.WriteLine($"Focused: {incident.Description}");
    }

    private void AddMarker(Incident incident)
    {
        // Mock lat/lon parsing for the demo if 'Location' is not "lat,lon"
        // Assuming Location is "40.7128, -74.0060" format for simplicity in this demo phase
        // Or generate random near NYC for demo
        double lat = 40.7128 + (Random.Shared.NextDouble() - 0.5) * 0.1;
        double lon = -74.0060 + (Random.Shared.NextDouble() - 0.5) * 0.1;

        if (incident.Location.Contains(","))
        {
            var parts = incident.Location.Split(',');
            if (parts.Length == 2 && double.TryParse(parts[0], out var l1) && double.TryParse(parts[1], out var l2))
            {
                lat = l1;
                lon = l2;
            }
        }

        JSRuntime.InvokeVoidAsync("addMarker", incident.Id.ToString(), lat, lon, incident.Description);
    }

    private string GetStatusClass(IncidentStatus status) => status switch
    {
        IncidentStatus.Created => "bg-created",
        IncidentStatus.Dispatched => "bg-dispatched",
        IncidentStatus.OnScene => "bg-onscene",
        IncidentStatus.Closed => "bg-closed",
        _ => "bg-secondary"
    };

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
